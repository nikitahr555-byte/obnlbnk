# Инструкция по деплою на Vercel

## Что я сделал для подготовки проекта к деплою на Vercel

### 1. Создал конфигурационные файлы

**`vercel.json`** - основная конфигурация Vercel:
- Настроил serverless функции для обработки API
- Настроил маршрутизацию для статических файлов и API
- Добавил правильные CORS заголовки
- Настроил переменные окружения

**`api/index.ts`** - точка входа для всех API запросов:
- Адаптировал Express приложение для работы в serverless среде
- Настроил обработку CORS для Telegram Web App
- Создал единый обработчик для всех API маршрутов

**`server/routes-vercel.ts`** - адаптированная версия серверных маршрутов:
- Убрал WebSocket функциональность (не поддерживается в Vercel)
- Убрал Telegram bot (требует постоянное соединение)
- Оставил только основные API endpoints

**`server/vite-vercel.ts`** - настройки статических файлов для production:
- Правильная обработка NFT изображений
- SPA маршрутизация для React приложения
- Кэширование статических ресурсов

**`.vercelignore`** - файлы которые не нужно загружать на Vercel:
- Исключил ненужные файлы разработки
- Убрал локальные базы данных и скрипты

### 2. Основные изменения

#### Убрал функции несовместимые с Vercel:
- WebSocket сервер (не поддерживается)
- Telegram bot в long polling режиме
- NFT image server (запуск отдельных процессов)
- Файловая система для загрузки изображений

#### Оставил основную функциональность:
- API для работы с NFT
- Авторизация пользователей
- Работа с базой данных
- Обслуживание React приложения
- CORS для Telegram Web App

### 3. Что нужно сделать для деплоя

#### Шаг 1: Подготовка
1. Убедитесь что все файлы закоммичены в GitHub
2. Создайте новый проект на Vercel
3. Подключите GitHub репозиторий

#### Шаг 2: Настройки проекта в Vercel
1. **Build Command**: `vite build`
2. **Output Directory**: `dist/public`
3. **Install Command**: `npm install`
4. **Framework Preset**: Other

#### Шаг 3: Переменные окружения
Добавьте в Vercel следующие переменные:

```
NODE_ENV=production
DATABASE_URL=your_database_url
TELEGRAM_BOT_TOKEN=your_bot_token
BLOCKDAEMON_API_KEY=your_api_key (если используете)
```

#### Шаг 4: База данных
1. Создайте PostgreSQL базу данных (рекомендую Neon.tech)
2. Получите DATABASE_URL
3. Добавьте её в переменные окружения Vercel

#### Шаг 5: Статические файлы NFT
Если у вас есть папки с NFT изображениями (`bored_ape_nft`, `bayc_official`, etc):
1. Убедитесь что они включены в репозиторий
2. Или используйте внешнее хранилище изображений (S3, Cloudinary)

### 4. ИСПРАВЛЕННЫЕ ПРОБЛЕМЫ

#### ✅ ERR_MODULE_NOT_FOUND

**Проблема**: `Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/var/task/server/storage'`

**Причина**: В ES modules (когда используется `"type": "module"` в package.json) необходимо указывать расширения файлов при импорте. Оригинальная ошибка возникала из-за:
1. Отсутствие расширений `.js` в imports
2. Неправильная структура сборки для Vercel

**РЕШЕНИЕ (уже применено)**:
1. ✅ **Обновлены все импорты в `server/routes-vercel.ts`** с добавлением расширений `.js`
2. ✅ **Упрощена сборка** - теперь файлы копируются напрямую без сложного bundling
3. ✅ **Создан `api/package.json`** с правильными настройками модулей
4. ✅ **Исправлен `build-fallback.js`** для корректной подготовки файлов

#### ✅ Ошибки drizzle-zod схем

**Проблема**: `TypeError: Cannot read properties of undefined (property 'omit')`

**Причина**: Неправильный синтаксис `createInsertSchema` в `shared/schema.ts`

**РЕШЕНИЕ (уже применено)**:
1. ✅ **Исправлены все схемы с неправильным синтаксисом**
```typescript
// Старый (неправильный) синтаксис:
export const insertUserSchema = createInsertSchema(users, {
  id: undefined,
  username: z.string(),
  // ...
});

// Новый (правильный) синтаксис:
export const insertUserSchema = createInsertSchema(users).omit({ id: true });
```

#### ✅ Проблемы с аутентификацией на Vercel

**Проблема**: Пользователь регистрируется, но получает 401 при последующих запросах

**Причина**: Serverless функции Vercel теряют состояние сессий между запросами

**РЕШЕНИЕ (уже применено)**:
1. ✅ **Обновлены настройки сессий для Vercel**:
```typescript
{
  resave: true, // Принудительно пересохраняем для Vercel
  saveUninitialized: true, // Создаем сессию для всех
  cookie: {
    secure: process.env.VERCEL ? true : false, // HTTPS для Vercel
    sameSite: process.env.VERCEL ? 'none' : 'lax' // Для кросс-доменности
  }
}
```
2. ✅ **Настроен PostgreSQL session store** с `connect-pg-simple` для постоянного хранения

**Теперь структура деплоя**:
```
api/
├── package.json        # ES modules конфигурация
├── index.ts           # Главная точка входа
├── server/            # Скопированные серверные файлы
└── shared/           # Скопированные общие типы
```

### 5. Другие возможные проблемы и решения

#### Проблема: "Показывает код вместо приложения"
**Решение**: 
- Убедитесь что `vercel.json` правильно настроен
- Проверьте что React приложение собирается в `dist/public`
- Проверьте маршрутизацию в vercel.json

#### Проблема: API не работает
**Решение**: 
- Проверьте что все API маршруты начинаются с `/api/`
- Убедитесь что база данных подключена
- Проверьте переменные окружения

#### Проблема: NFT изображения не загружаются
**Решение**: 
- Переместите изображения в `client/public/` папку
- Или используйте внешний CDN
- Обновите пути к изображениям в коде

#### Проблема: CORS ошибки в Telegram
**Решение**: 
- Убедитесь что домен Vercel добавлен в настройки Telegram бота
- Проверьте CORS настройки в `api/index.ts`

### 5. Ограничения Vercel

- **Время выполнения**: максимум 10 секунд на запрос
- **Размер**: максимум 50MB на deployment
- **База данных**: нужна внешняя (не SQLite)
- **Файлы**: нет постоянной файловой системы
- **WebSocket**: не поддерживается
- **Long running processes**: не поддерживается

### 6. Рекомендации

1. **Используйте внешнюю базу данных** (PostgreSQL на Neon.tech)
2. **Храните изображения в CDN** (Cloudinary, AWS S3)
3. **Минимизируйте размер build'а** (исключите ненужные файлы)
4. **Тестируйте локально** перед деплоем
5. **Мониторьте логи Vercel** для отладки

### 7. После успешного деплоя

1. Обновите URL в настройках Telegram бота
2. Проверьте все основные функции приложения
3. Настройте домен (если нужен)
4. Настройте мониторинг и логирование

## Заключение

Проект полностью подготовлен для деплоя на Vercel. Основная функциональность сохранена, убраны только компоненты несовместимые с serverless архитектурой.

После деплоя вы получите полнофункциональное Telegram Web App с NFT маркетплейсом, которое будет работать так же как и на Replit, но с лучшей производительностью и масштабируемостью.