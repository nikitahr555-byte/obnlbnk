# Руководство по резервному копированию и восстановлению базы данных

## Обзор

Этот документ описывает процедуры резервного копирования и восстановления базы данных SQLite, используемой в приложении OOO BNAL BANK. Надлежащее резервное копирование критически важно, особенно при использовании Render.com, где файловая система по умолчанию эфемерна.

## Автоматическое резервное копирование

Приложение настроено на автоматическое создание резервных копий базы данных следующими способами:

### На Render.com

1. **Регулярные интервальные резервные копии**
   - Каждые 15 минут база данных автоматически копируется в постоянное хранилище
   - Резервные копии сохраняются в директории `/opt/render/project/src/data/backup`
   - Поддерживается ротация резервных копий (хранятся последние 5 копий)

2. **Резервные копии при завершении работы**
   - При получении сигналов SIGTERM или SIGINT (остановка сервиса)
   - База данных копируется в постоянное хранилище перед завершением работы

3. **Резервные копии при запуске**
   - При каждом запуске приложения создается копия с префиксом `pre_start_`
   - Это обеспечивает точку восстановления непосредственно перед запуском

### В Replit

1. **Регулярные интервальные резервные копии**
   - База данных автоматически копируется в директорию `backup` каждый час
   - Резервные копии включают временную метку для облегчения идентификации

## Ручное резервное копирование

### Через веб-интерфейс

1. Войдите в систему как администратор
2. Перейдите в раздел "Регулятор" → "Управление системой"
3. Нажмите кнопку "Создать резервную копию"
4. Скачайте созданный файл резервной копии на локальный компьютер

### Через командную строку (Replit)

```bash
# Создание копии текущей базы данных
cp sqlite.db backup/sqlite_backup_$(date +"%Y%m%d_%H%M%S").db

# Архивирование базы данных с текущей датой
zip -j backup/sqlite_backup_$(date +"%Y%m%d_%H%M%S").zip sqlite.db
```

### Через командную строку (Render.com)

Вы можете использовать SSH-доступ к серверу или запустить скрипт через интерфейс Render.com:

```bash
# Создание резервной копии
cp /opt/render/project/src/data/sqlite.db /opt/render/project/src/data/backup/manual_backup_$(date +"%Y%m%d_%H%M%S").db

# Архивирование базы данных для скачивания
cd /opt/render/project/src
zip -j data/backup/sqlite_backup_$(date +"%Y%m%d_%H%M%S").zip data/sqlite.db
```

## Скачивание резервных копий

### На Render.com

1. Используйте SFTP для подключения к серверу
2. Скачайте файлы из директории `/opt/render/project/src/data/backup/`

### На Replit

1. Используйте веб-интерфейс Replit для скачивания файлов
2. Перейдите в директорию `backup` и скачайте нужные файлы

## Восстановление базы данных

### Через веб-интерфейс (рекомендуется)

1. Войдите в систему как администратор
2. Перейдите в раздел "Регулятор" → "Управление системой"
3. Нажмите кнопку "Восстановить из резервной копии"
4. Загрузите файл резервной копии (.db или .zip)
5. Подтвердите восстановление

### На Render.com через командную строку

```bash
# Остановите сервис перед восстановлением через панель управления Render.com

# Восстановление из резервной копии
cp /opt/render/project/src/data/backup/your_backup_file.db /opt/render/project/src/data/sqlite.db
cp /opt/render/project/src/data/sqlite.db /opt/render/project/src/sqlite.db
```

### На Replit через командную строку

```bash
# Создание резервной копии текущей базы перед восстановлением
cp sqlite.db sqlite.db.before_restore

# Восстановление из резервной копии
cp backup/your_backup_file.db sqlite.db
```

## Рекомендации по безопасности

1. **Регулярно скачивайте копии** на локальный компьютер
2. **Шифруйте резервные копии** перед долгосрочным хранением
3. **Проверяйте целостность** резервных копий регулярно
4. **Тестируйте процесс восстановления** на тестовой среде

## Решение проблем

### Повреждение базы данных

Если база данных повреждена, восстановите из последней резервной копии:

```bash
# На Render.com
cp /opt/render/project/src/data/backup/latest_backup.db /opt/render/project/src/data/sqlite.db
cp /opt/render/project/src/data/sqlite.db /opt/render/project/src/sqlite.db

# На Replit
cp backup/latest_backup.db sqlite.db
```

### Потеря данных в Render.com

Если том был потерян или поврежден, восстановите из внешней резервной копии:

1. Загрузите резервную копию на сервер
2. Восстановите базу данных, используя инструкции выше
3. Перезапустите сервис

## Расписание резервного копирования

| Тип | Частота | Место хранения | Хранение |
|-----|---------|----------------|----------|
| Автоматическое | Каждые 15 минут | Постоянный том | Последние 5 копий |
| При запуске | Каждый запуск | Постоянный том | Неограниченно |
| При остановке | Каждая остановка | Постоянный том | Неограниченно |
| Ручное | По требованию | Локальный компьютер | Зависит от администратора |