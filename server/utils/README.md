# Улучшенная система обработки ошибок и диагностики приложения

Эта документация описывает систему обработки ошибок, мониторинга и диагностики, которая была добавлена в приложение для повышения его надежности, особенно при работе с реальными блокчейн-транзакциями.

## Основные компоненты системы

### Модуль обработки ошибок (`error-handler.ts`)

Централизованный модуль для обработки ошибок всех типов с:
- Иерархией специализированных ошибок (`ValidationError`, `AuthenticationError`, `DatabaseError`, `BlockchainError`)
- Глобальными обработчиками для необработанных исключений
- Расширенным логированием ошибок с контекстом

### Модуль решения проблем (`problem-solver.ts`)

Модуль для автоматической диагностики и решения распространенных проблем:
- Проверка доступа к BlockDaemon API
- Проверка подключения к базе данных
- Обнаружение и исправление проблем с криптоадресами
- Автоматическое исправление зависших транзакций

### Мониторинг здоровья системы (`health-monitor.ts`)

Модуль для отслеживания состояния системы в реальном времени:
- Отслеживание используемой памяти и CPU
- Мониторинг подключения к базе данных
- Хранение истории последних ошибок
- Определение общего статуса системы

### Мониторинг транзакций (`transaction-monitor.ts`)

Модуль для отслеживания статуса транзакций:
- Периодическая проверка статуса ожидающих транзакций
- Автоматическое завершение зависших транзакций
- Система повторных попыток для проверки реальных транзакций

### Усовершенствованные модули для взаимодействия с внешними сервисами

- Улучшенная версия `blockchain.ts` с механизмом повторных попыток и детальным логированием
- Улучшенная версия `db.ts` с надежной обработкой ошибок базы данных

## API для диагностики

В приложение добавлен новый API эндпоинт `/api/diagnostics/` с маршрутами:

- `GET /api/diagnostics/api-keys` - Проверка статуса API ключей
- `GET /api/diagnostics/run` - Запуск полной диагностики системы
- `GET /api/diagnostics/health` - Получение информации о здоровье системы
- `POST /api/diagnostics/clear-errors` - Очистка лога ошибок
- `POST /api/diagnostics/transactions/start-monitoring` - Запуск мониторинга транзакций
- `GET /api/diagnostics/transactions/pending` - Получение списка ожидающих транзакций
- `GET /api/diagnostics/transactions/:id/check` - Проверка статуса транзакции
- `POST /api/diagnostics/transactions/:id/track` - Добавление транзакции для отслеживания
- `POST /api/diagnostics/transactions/fix-stuck` - Исправление зависших транзакций
- `GET /api/diagnostics/blockchain-api` - Проверка доступности BlockDaemon API

## Как использовать диагностический API

Для регулярной проверки состояния системы и исправления проблем с транзакциями можно выполнять следующие шаги:

1. Проверить здоровье системы: `GET /api/diagnostics/health`
2. Запустить полную диагностику: `GET /api/diagnostics/run`
3. Если обнаружены проблемы с транзакциями, исправить зависшие: `POST /api/diagnostics/transactions/fix-stuck`
4. Проверить, что API ключи для блокчейна работают: `GET /api/diagnostics/api-keys`

Для мониторинга конкретной транзакции:
1. Добавить транзакцию для отслеживания: `POST /api/diagnostics/transactions/:id/track`
2. Проверить статус: `GET /api/diagnostics/transactions/:id/check`

## Как обновить приложение до новой версии

Для обновления приложения с улучшенной обработкой ошибок:

1. Замените оригинальные модули их новыми версиями из директории `server/utils/new_modules/`
2. Используйте новую версию `server/utils/new_modules/index.ts` вместо текущей `server/index.ts`
3. Добавьте новые модули: `error-handler.ts`, `problem-solver.ts`, `health-monitor.ts`, `transaction-monitor.ts`
4. Добавьте новый API эндпоинт из `diagnostic-routes.ts`

## Рекомендации по дальнейшему улучшению

- Интегрировать внешнюю систему мониторинга для отслеживания ошибок
- Расширить автоматические тесты для проверки системы обработки ошибок
- Создать панель администратора для управления блокчейн-транзакциями