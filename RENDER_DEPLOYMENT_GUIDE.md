# Руководство по деплою на Render.com

## Обзор

Это руководство описывает процесс миграции приложения с Replit на Render.com. Render.com предоставляет более стабильное и постоянное хостинг-решение с фиксированным URL, что делает его идеальным для продакшн-окружения и для работы Telegram-бота.

## Содержание

1. [Требования](#требования)
2. [Подготовка к деплою](#подготовка-к-деплою)
3. [Настройка на Render.com](#настройка-на-rendercom)
4. [Постоянное хранилище данных](#постоянное-хранилище-данных)
5. [Переменные окружения](#переменные-окружения)
6. [Телеграм бот на Render.com](#телеграм-бот-на-rendercom)
7. [Устранение неполадок](#устранение-неполадок)

## Требования

- Аккаунт GitHub для хранения кода
- Аккаунт Render.com 
- Токен Telegram-бота

## Подготовка к деплою

1. **Создание репозитория на GitHub**
   - Создайте новый приватный репозиторий на GitHub
   - Загрузите весь проект на GitHub

2. **Проверка готовности проекта к деплою**
   - Запустите скрипт для проверки готовности проекта:
     ```
     node scripts/prepare-for-render.js
     ```
   - Скрипт проверит наличие необходимых файлов и создаст директорию для базы данных

3. **Убедитесь, что следующие файлы присутствуют**:
   - `render.yaml` - настройки инфраструктуры
   - `build.sh` - скрипт сборки
   - `start.sh` - скрипт запуска
   - `data/sqlite.db` - копия базы данных

## Настройка на Render.com

1. **Создайте новый Web Service**:
   - Войдите в аккаунт Render.com
   - Нажмите "New +" > "Web Service"
   - Выберите репозиторий GitHub с вашим проектом

2. **Настройте сервис**:
   - **Name**: Задайте имя вашего сервиса
   - **Region**: Выберите регион, ближайший к вашим пользователям
   - **Branch**: Выберите ветку с кодом (обычно `main`)
   - **Runtime**: Node.js
   - **Build Command**: `chmod +x build.sh && ./build.sh`
   - **Start Command**: `chmod +x start.sh && ./start.sh`
   - **Plan**: Выберите подходящий план (для базового функционала достаточно Free)

## Постоянное хранилище данных

1. **Создайте Disk Volume**:
   - В настройках сервиса перейдите в раздел "Disks"
   - Создайте новый диск:
     - **Name**: `data`
     - **Mount Path**: `/opt/render/project/src/data`
     - **Size**: Выберите размер исходя из ваших потребностей (минимум 1 GB)

2. **Поведение на Render.com**:
   - Приложение автоматически инициализирует базу данных в директории `/opt/render/project/src/data`
   - Регулярные бэкапы базы данных выполняются автоматически каждые 15 минут
   - При перезапуске сервиса данные сохраняются благодаря постоянному тому

## Переменные окружения

Установите следующие переменные окружения в настройках сервиса:

| Переменная | Значение | Описание |
|------------|----------|----------|
| `NODE_ENV` | `production` | Режим работы Node.js |
| `RENDER` | `true` | Индикатор работы на Render.com |
| `TELEGRAM_BOT_TOKEN` | `ваш_токен` | Токен Telegram-бота |

## Телеграм бот на Render.com

1. **Настройка Webhook**:
   - Бот автоматически определяет среду и в режиме `production` на Render.com использует webhook
   - URL вебхука формируется в формате: `https://ваш-домен.onrender.com/bot/webhook`

2. **Перенастройка команд**:
   - Если вы задавали команды бота вручную, необходимо перенастроить их командой:
     ```
     https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/setMyCommands?commands=[{"command":"start","description":"Старт работы с ботом"},{"command":"card","description":"Управление картами"}]
     ```

## Устранение неполадок

### База данных

- **Проблема**: Данные не сохраняются после перезагрузки сервиса.
  - **Решение**: Убедитесь, что создан постоянный диск и правильно установлен путь монтирования.

- **Проблема**: Ошибка базы данных при старте приложения.
  - **Решение**: Проверьте логи Render.com и убедитесь, что директория `/opt/render/project/src/data` имеет права на запись.

### Телеграм бот

- **Проблема**: Бот не отвечает после перехода на Render.com.
  - **Решение 1**: Проверьте логи Render.com на наличие ошибок.
  - **Решение 2**: Убедитесь, что переменная `TELEGRAM_BOT_TOKEN` установлена правильно.
  - **Решение 3**: Вручную перенастройте webhook:
    ```
    https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/setWebhook?url=https://ваш-домен.onrender.com/bot/webhook
    ```

### WebSocket

- **Проблема**: WebSocket не работает, когда приложение запущено на HTTPS.
  - **Решение**: Обновлен клиентский код для автоматического использования WSS при HTTPS подключении.

## Дополнительная информация

- **Логи**: Доступны в панели управления Render.com в разделе "Logs"
- **Резервные копии**: Автоматически создаются в директории `/opt/render/project/src/data/backup`
- **Перезапуск**: Можно выполнить вручную из панели управления Render.com